<html>
<head>
 <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> 
 <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>
 <link rel="stylesheet" type="text/css"  href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/themes/ui-lightness/jquery-ui.min.css"/>
 <link rel="stylesheet" href="frame.css" type="text/css" media="all"/>
<script type="text/javascript" charset="utf-8">
var gContinueScanning = true;
var myLayout;

function find_loaded_link()
{
  // var t=setTimeout("javascript statement",milliseconds);
  var framebody = undefined;
  var curlink = undefined;
  var link = undefined;
  try {
    framebody = $('#aiframe').get(0).contentWindow.document.body;
    curlink = $('#link-to-this-event a',framebody)
    link = curlink.attr('href');    
  }
  catch(err)
  {}
  if(link) {
    $('#links .entry').removeClass('currentEvent');      
    // $('#links').append('<p>'+link+'</p>');
    var match = [];
    // $('#links .entry a').each(function(){
    //   console.log("matching");
    //   console.log($(this).attr('href'));
    //   console.log(link);
    //   if($(this).attr('href')==link)
    //     match.push(this);
    // })
    var match = $('#links').find('.entry:has(a[href="'+link+'"])');
    // console.log(match);
    if (match.length > 0) {
      $(match).addClass('currentEvent');
    }
    // console.log(link);
  }
  if(gContinueScanning) gScanLinksTimer = setTimeout("find_loaded_link()",500);
}

function copy_from_textarea()
{
  $('#links').html('');
  var datastring = $('#save-form textarea').val();
  var data = datastring.split("\n");
  for(var i=0;i<data.length;i++) {
    if(data[i].length>1) {
      var items = data[i].replace(/\s+/, '\x01').split('\x01'); // split off first whitespace, leave the rest.
      var link = items[0];
      var name = items[1];
      if(name===undefined) name = "Event " + (i+1);
      var entry = "<div class='entry'>";
      entry  += '<a href="'+link+'" target="aiframe">' + name + '</a>';
      entry += "</div>";
      $('#links').append(entry);
    }
    console.log(data[i]);
  }
}


function copy_to_textarea()
{
  var mydata = "";
  $('#links .entry a').each(function(){
    var link = $(this).attr('href');
    console.log(link);
    if(link) mydata += link + "\t" + $(this).text() + "\n";
  });
  console.log(mydata);
  $('#save-form textarea').val(mydata);
}

function save_links()
{
  // copy_to_textarea();
  $('form#save-form').submit();
}

function add_current_event()
{
  var framebody = undefined;
  var curlink = undefined;
  var link = undefined;
  var eventid = undefined;
  try {
    framebody = $('#aiframe').get(0).contentWindow.document.body;
    curlink = $('#link-to-this-event a',framebody)
    link = curlink.attr('href');    
    eventid = $('.event-info-det',framebody).text() + "|"
            + $('.event-info-run',framebody).text() + "|"
            + $('.event-info-subrun',framebody).text() + "|"
            + $('.event-info-gate',framebody).text() + "|"
            + $('.event-info-slice',framebody).html();
  }
  catch(err){ return; }
  if(link) {
    var match = $('#links').find('.entry:has(a[href="'+link+'"])');
    if (match.length > 0) return; // already have this one.
    var data = $('#save-form textarea').val();
    console.log(link);
    console.log(eventid);
    data += "\n" + link + '\t' + eventid;
    $('#save-form textarea').val(data);
  }
  copy_from_textarea();
}


$(function(){
  // Startup: copy links to DOM.
  copy_from_textarea();
  // See if there's a first link.
  // var as = $('#links .entry a');
  // if(as.length>0) {
  //   as.get(0).click();
  // } else {
    $('#aiframe').attr('src',"../arachne.html");
  // }
  
})

$(function(){
  gScanLinksTimer = setTimeout("find_loaded_link()",500);  
})


function myResize(div) {
  var remainingSpace = $(div).parent().width() - $(div).outerWidth();
  var divTwo = $(div).next();
  var divTwoWidth = remainingSpace - (divTwo.outerWidth() - divTwo.width())-30;
  divTwo.css('width', divTwoWidth + 'px');
  console.warn("myResize",div,divTwo,divTwoWidth,remainingSpace);
}

$(document).ready(function(){
  $('#MySplitter > div:first').resizable({
    handles: 'e',
    minWidth : '100',
    maxWidth : '400',
    resize: function(){myResize(this);}
  });
  myResize($('#MySplitter > div:first'));
});


</script>

</head>
<body>
  <div id='MySplitter'>
  <div id='sidebar'>
    <a href='about.html' target='aiframe'>About the Roundup</a>
    <div id='links'>
      <!-- PERL_DOES_ITS_STUFF_HERE -->
    </div>

    <button onclick="add_current_event()">Add Current Event</button>
    <button onclick="save_links()">Save This Roundup</button>
  </div>
  
  
  <div id='aiframe-div'>
    <iframe  width='100%' height='100%' id='aiframe'  name='aiframe'></iframe>
  </div>
</div>

    <div id='myform-div' style='display:block;'>
        
    <form id='save-form'  method='post' >
    You can add your own events to this text field. The format is:</br>
    Link [whitespace] Caption
    After you have added events, click the 'Save This Roundup'.
    <textarea name='links' rows='10' columns='100'>PERL_WILL_FILL_THIS_WITH_RAW</textarea>
    <button onclick="save_links()">Save This Roundup</button>
    </form>   
    </div>
</body>
</html>
<!-- src="http://minerva05.fnal.gov/Arachne/arachne.html"  -->